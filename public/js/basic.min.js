var intervalVotes=false;var usedGeolocation=false;var oldVoteData=null;var voting_over_interval_multiplier=1;var ajax_retry_time_max=3000;var ajax_retry_count_max=10;var location_max_delay=10000;var nearplace_radius_default=500;var nearplace_radius_max_default=1000;var SHOW_DETAILS_MIN_WIDTH=800;var width_device=(window.innerWidth>0)?window.innerWidth:screen.width;function isMobileDevice(){return/Android|webOS|iPhone|iPad|iPod|BlackBerry|MIDP|Nokia|J2ME/i.test(navigator.userAgent)}function detectIE(){var c=window.navigator.userAgent;var b=c.indexOf("MSIE ");var a=c.indexOf("Trident/");if(b>0){return parseInt(c.substring(b+5,c.indexOf(".",b)),10)}if(a>0){var d=c.indexOf("rv:");return parseInt(c.substring(d+3,c.indexOf(".",d)),10)}return false}$.extend({keys:function(c){var b=[];$.each(c,function(a){b.push(a)});return b}});function vote_helper(d,b,c,a){if(typeof _paq!="undefined"&&d!="vote_get"){_paq.push(["trackEvent","Voting",d,b,c])}$.ajax({type:"POST",url:"/vote.php",data:{action:d,identifier:b,note:c,userid:$("#userid").html(),date:$("#date").val(),lat:$("#lat").html(),lng:$("#lng").html(),radius:nearplace_radius_default,radius_max:nearplace_radius_max_default,sensor:(typeof navigator.geolocation!="undefined")},dataType:"json",success:function(e){if(intervalVotes){clearInterval(intervalVotes)}if(typeof e.voting_over!="undefined"&&e.voting_over||!e||typeof e.alert!="undefined"){voting_over_interval_multiplier+=0.1}else{voting_over_interval_multiplier=1}intervalVotes=setInterval(function(){vote_get()},Math.floor(5000*voting_over_interval_multiplier));if(typeof JSON!="undefined"&&JSON.stringify(oldVoteData)==JSON.stringify(e)&&typeof e.alert=="undefined"){return}if(typeof e.alert!="undefined"){alert(e.alert)}else{if(typeof e.html!="undefined"){$("#dialog_ajax_data").html(e.html)}else{if(intervalVotes){$("#dialog_vote_summary").hide()}}}oldVoteData=e;emoji_update()},error:function(){if(a<ajax_retry_count_max){window.setTimeout(function(){vote_helper(d,b,c,a+1)},(Math.random()*ajax_retry_time_max)+1)}else{alert("Fehler beim Abfragen/Setzen der Votes.")}}})}function vote_up(a){vote_helper("vote_up",a,null,0);$("#dialog_vote_summary").show();adapt_button_vote_summary_toggle()}function vote_down(a){vote_helper("vote_down",a,null,0);$("#dialog_vote_summary").show();adapt_button_vote_summary_toggle()}function vote_special(a){$("#noteInput").val(a);vote_helper("vote_special",a,null,0);$("#dialog_vote_summary").show();adapt_button_vote_summary_toggle()}function vote_set_note(a){vote_helper("vote_set_note",null,a,0);$("#dialog_vote_summary").show();adapt_button_vote_summary_toggle()}function vote_get(){vote_helper("vote_get",null,null,0)}function vote_delete(){$("#noteInput").val("");vote_helper("vote_delete",null,null,0)}function vote_delete_part(a){if(a=="special"){$("#noteInput").val("")}vote_helper("vote_delete_part",a,null,0)}function positionHandler(a){lat=a.coords.latitude;lng=a.coords.longitude;$.ajax({type:"GET",url:"/locator.php",data:{action:"latlngToAddress",lat:lat,lng:lng,userid:$("#userid").html()},dataType:"json",success:function(b){if(b&&typeof b.address!="undefined"&&b.address){usedGeolocation=true;$("#location").html(b.address);$("#locationInput").val(b.address);sortVenuesAfterPosition(lat,lng)}},error:function(){sortVenuesAfterPosition(lat,lng)}})}function positionErrorHandler(a){sortVenuesAfterPosition($("#lat").html(),$("#lng").html())}function distanceLatLng(g,m,f,k){g=parseFloat(g);m=parseFloat(m);f=parseFloat(f);k=parseFloat(k);var e=Math.PI/180;g*=e;m*=e;f*=e;k*=e;var d=6372.797;var h=f-g;var i=k-m;var l=Math.sin(h/2)*Math.sin(h/2)+Math.cos(g)*Math.cos(f)*Math.sin(i/2)*Math.sin(i/2);var j=2*Math.atan2(Math.sqrt(l),Math.sqrt(1-l));var b=d*j;return b}function sortVenuesAfterPosition(d,c){$("#lat").html(d);$("#lng").html(c);var a=new Array();$.each($(".venueDiv"),function(){var g=$(this).prop("id");var e=$(this).children(".lat").html();var f=$(this).children(".lng").html();a[g]=distanceLatLng(d,c,e,f)});var b=$('[class="venueDiv"]');b.sort(function(g,f){var e=$(g).prop("id");var j=$(f).prop("id");var i=a[e];var h=a[j];if(i>h){return 1}else{if(i<h){return -1}else{return 0}}});$("#venueContainer").html(b);$(document).trigger("locationReady")}function setLocation(b,c,a){if(!b||c){if((isMobileDevice()||c)&&navigator.geolocation){navigator.geolocation.getCurrentPosition(positionHandler,positionErrorHandler,{timeout:5000})}else{sortVenuesAfterPosition($("#lat").html(),$("#lng").html())}$.removeCookie("location");return}usedGeolocation=false;$.ajax({type:"GET",url:"/locator.php",data:{action:"addressToLatLong",address:b,userid:$("#userid").html()},dataType:"json",success:function(d){if(d&&typeof d.lat!="undefined"&&d.lat&&typeof d.lng!="undefined"&&d.lng){$("#location").html(b);$("#locationInput").val(b);sortVenuesAfterPosition(d.lat,d.lng);$.cookie("location",b,{expires:7})}else{$("#locationInput").val($("#location").html());alert("Keine Geo-Daten zu dieser Adresse gefunden.")}},error:function(){if(a<ajax_retry_count_max){window.setTimeout(function(){setLocation(b,c,a+1)},(Math.random()*ajax_retry_time_max)+1)}else{alert("Fehler beim Abrufen der Geo-Position. Bitte Internetverbindung überprüfen.")}}})}function setDistance(e){if(typeof e!="undefined"){$("#distance").val(e);if($("#distance").hasClass("ui-slider-input")){$("#distance").slider("refresh")}$.cookie("distance",e,{expires:7})}var d=$("#lat").html();var b=$("#lng").html();var e=$("#distance").val();var a="ABCDEFGHIJKLMNOPQRSTUVWXYZ";var c=0;$.each($(".venueDiv"),function(){var h=$(this).children(".lat").html();var k=$(this).children(".lng").html();var j=$(this);var l=$(".title",j).text();var f="";var i=distanceLatLng(d,b,h,k);var g=Math.floor(Number((i).toFixed(2))*1000);if(i>=1){f="~ "+i.toFixed(1)+" km"}else{f="~ "+g+" m"}if(g>e){$(this).hide();$(this).attr("data-inreach",false)}else{if(!$(this).attr("data-userhidden")){$(this).show()}$(this).attr("data-inreach",true)}j.children(".distance").remove();j.append("<div class='distance'>Distanz: "+f+"</div>")});if($('[class="venueDiv"][data-inreach="true"]').length<1){$("#noVenueFoundNotifier").show()}else{$("#noVenueFoundNotifier").hide()}}function updateNotePreview(){$("#notePreview").html(emojione.toImage($("#noteInput").val()))}function handle_href_reference_details(d,a,c,b){$.ajax({type:"GET",url:"/nearplaces.php",data:{action:"details",id:d,reference:a,sensor:(typeof navigator.geolocation!="undefined"),userid:$("#userid").html()},dataType:"json",async:false,success:function(e){if(typeof e.alert!="undefined"){alert(e.alert)}if(typeof e.result.website!="undefined"){window.open(e.result.website,"_blank")}else{window.open("https://duckduckgo.com/?q="+c,"_blank")}},error:function(){if(b<ajax_retry_count_max){window.setTimeout(function(){handle_href_reference_details(d,a,c,b+1)},(Math.random()*ajax_retry_time_max)+1)}else{alert("Fehler beim Abholen der Restaurants in der Nähe.")}}})}function get_alt_venues(e,c,a,d,f,b){$.ajax({type:"GET",url:"/nearplaces.php",data:{action:"nearbysearch_staged",lat:e,lng:c,radius:a,radius_max:d,sensor:(typeof navigator.geolocation!="undefined"),userid:$("#userid").html()},dataType:"json",success:function(g){if(typeof g.alert!="undefined"){alert(g.alert)}else{return f(g)}},error:function(){if(b<ajax_retry_count_max){window.setTimeout(function(){get_alt_venues(e,c,a,d,f,b+1)},(Math.random()*ajax_retry_time_max)+1)}else{alert("Fehler beim Abholen der Restaurants in der Nähe.")}}})}function vote_settings_save(){$.ajax({type:"POST",url:"/users.php",data:{action:"user_config_set",name:$("#name").val(),email:$("#email").val(),vote_reminder:$("#vote_reminder").is(":checked"),voted_mail_only:$("#voted_mail_only").is(":checked"),vote_always_show:$("#vote_always_show").is(":checked"),userid:$("#userid").html()},dataType:"json",success:function(a){if(typeof a.alert!="undefined"){alert(a.alert)}},error:function(){alert("Fehler beim Setzen der Vote-Einstellungen.")}})}function emoji_update(){if(typeof emojione=="undefined"){return}$(".convert-emoji").not("[data-emoji-converted]").each(function(){$(this).attr("data-emoji-converted",true);$(this).html(emojione.toImage($(this).html()))})}function adapt_button_vote_summary_toggle(){if($("#dialog_vote_summary").is(":visible")){$("#button_vote_summary_toggle").val("Voting Ausblenden").html("Voting Ausblenden")}else{$("#button_vote_summary_toggle").val("Voting Anzeigen").html("Voting Anzeigen")}}function venue_hide(b){var a=$.cookie("venues_hidden");if(typeof a!="object"){a=new Array()}a.push(b);$.cookie("venues_hidden",a,{expires:31});$("#"+b).hide()}function init_cookie(){$(document).ready(function(){$.cookie.json=true;$.each($.cookie("venues_hidden"),function(b,c){$("#"+c).hide();$("#"+c).attr("data-userhidden",true)});var a=$.cookie("location");if(typeof a!="undefined"&&a&&a.length){setLocation(a,false,0)}else{setLocation(null,false,0)}})}function init_emoji(){$(document).ready(function(){emojione.ascii=true;emojione.imageType="png";emojione.sprites=true;emoji_update();if(!$("#noteInput").length){return}$("#noteInput").on("keyup change input",function(a){updateNotePreview()});updateNotePreview();$.getJSON("emojione/emoji.json?2",function(a){a.toilet.keywords.push("heisl");a.spaghetti.keywords.push("pasta");$("#noteInput").textcomplete([{match:/\B:([\-+\w]*)$/,search:function(e,g){var d=[];var c=[];var b=[];$.each(a,function(h,i){if(h.indexOf(e)>-1){d.push(h)}else{if((i.aliases!==null)&&(i.aliases.indexOf(e)>-1)){c.push(h)}else{if((i.keywords!==null)&&(i.keywords.indexOf(e)>-1)){b.push(h)}}}});if(e.length>=3){d.sort(function(i,h){return(i.length>h.length)});c.sort(function(i,h){return(i.length>h.length)});b.sort()}var f=d.concat(c).concat(b);g(f)},template:function(b){return'<img class="emojione" src="./emojione/png/'+a[b].unicode+'.png"> :'+b+":"},replace:function(b){return":"+b+": "},index:1,maxCount:10}],{footer:'<a href="http://www.emoji.codes" target="_blank">Alle Anzeigen<span class="arrow">»</span></a>'})})})}function init_datatables(){$(document).ready(function(){$("#table_stats").dataTable({order:[[4,"desc"]],dom:"<lfpti>",lengthChange:false,searching:true,fnDrawCallback:function(a){$("#table_stats_filter input").attr("type","text").attr("data-type","search");$("#table_stats_filter input").textinput();emoji_update()}});$("#table_stats").show();$("#table_ingredients").dataTable({order:[[2,"desc"]],dom:"<lfpti>",lengthChange:false,searching:false});$("#table_ingredients").show();$("#table_compositions").dataTable({order:[[2,"desc"]],dom:"<lfpti>",lengthChange:false,searching:false});$("#table_compositions").show();$("#loader_stats").hide()})}$(document).ready(function(){if(width_device<=SHOW_DETAILS_MIN_WIDTH){$("#location").hide()}var a=detectIE();if(a&&a<=8){alert("Bitte neueren Internet Explorer verwenden!")}if($("#show_voting").length){vote_get()}$("#date").bind("change",function(){var b=$("#userid").html();if(b&&b.length){document.location=window.location.protocol+"//"+window.location.host+window.location.pathname+"?date="+$(this).val()+"&userid="+b}else{document.location=window.location.protocol+"//"+window.location.host+window.location.pathname+"?date="+$(this).val()}});$("#locationForm").submit(function(b){b.preventDefault();$("#setLocationDialog").dialog("close");setDistance($("#distance").val());setLocation($("#locationInput").val(),false,0)});$("#noteForm").submit(function(b){b.preventDefault();$("#setNoteDialog").dialog("close");vote_set_note($("#noteInput").val())});$("#button_vote_summary_toggle").click(function(){var b=$("#dialog_vote_summary");if(b.is(":visible")){b.hide()}else{b.show()}adapt_button_vote_summary_toggle()});if($("#vote_always_show").is(":checked")){$("#dialog_vote_summary").show();setTimeout(function(){adapt_button_vote_summary_toggle()},0)}$("#tabs").on("tabsactivate",function(d,e){if(e.newTab.index()==1){var f=$("#lat").html();var b=$("#lng").html();$("#table_voting_alt").hide();$("#div_voting_alt_loader").show();var c=new Array();get_alt_venues(f,b,nearplace_radius_default,nearplace_radius_max_default,function(g){if($.fn.DataTable.isDataTable("#table_voting_alt")){$("#table_voting_alt").dataTable().fnDestroy()}$("#table_voting_alt").dataTable({data:g,columns:[{title:"Name"},{title:"Distanz"},{title:"Aktionen"}],order:[[1,"asc"]],initComplete:function(i,h){$("#table_voting_alt_wrapper select").selectmenu();$("#table_voting_alt_wrapper input").textinput()},fnDrawCallback:function(h){$("#table_voting_alt_filter input").attr("type","text").attr("data-type","search");$("#table_voting_alt_filter input").textinput();$("#table_voting_alt_wrapper div.ui-link").button({enhanced:true})},dom:"<lfpti>",lengthChange:false,searching:true});$("#div_voting_alt_loader").hide();$("#table_voting_alt").show()},0)}})});var locationReadyFired=false;$(document).on("locationReady",function(){$(document).ready(function(){locationReadyFired=true;var a=$.cookie("distance");if(typeof a=="undefined"){a=$("#distance_default").html()}setDistance(a);$("#loadingContainer").hide();$(".lat_lng_link").each(function(c,d){var b=$(this).prop("href");b=b.replace("@@lat_lng@@",$("#lat").html()+","+$("#lng").html());$(this).prop("href",b)})})});setTimeout(function(){if(!locationReadyFired){$(document).trigger("locationReady")}},location_max_delay);